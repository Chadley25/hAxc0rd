module.exports = {
    name: "gobuster",
    category: "exploit",
    description: "",
    run: async (client, message, args) => {
        const { exec } = require('child_process');
        const Discord = require('discord.js');
        let arguments = message.toString().slice((message.content).substr(0,message.content.indexOf(' ')).length + 1);
        
        if (args[0] == "help") {
            // displays information about the tool being used
            const helpEmbed = new Discord.MessageEmbed()
                .setColor('#f01d0e')
                .setTitle('Gobuster - Help')
                .addField('Description', "Gobuster is a tool used to brute-force URLs (directories and files) in web sites, DNS subdomains, and Virtual Host names on target web servers. For this though, we're only going to be focusing on brute-forcing URLs.")
                .addField('Arguments', "[-w wordlist (small, medium, big)] ~ specifies the wordlist to be used when brute forcing directories\n[-u URL] ~ specifies the URL to attack")
                .addField('Examples', 'gobuster -w medium -u https://chadley25.github.io\ngobuster -u http://127.0.0.1 -w big')
                .addField('More Information', 'https://github.com/OJ/gobuster')    
            message.channel.send(helpEmbed);
        } else { // executes the "gobuster" command locally and displays the output live
            // checks to make sure the user specifies a wordlist that comes by default
            wordlistOptions = ['small', 'medium', 'big']
            var wordlistSpecifyIndex = arguments.indexOf("-w");
            var wordlist = arguments.substr(wordlistSpecifyIndex+3).split(" ")[0];
            if (!wordlistOptions.includes(wordlist)) {
                message.reply("the wordlist you specified is not in the lists of ones you can use.");
            }
            arguments = arguments.replace("-w " + wordlist, "-w wordlists/" + wordlist);
            var child = exec(`gobuster ${arguments}`, {detached: true});
            message.channel.send("*Note: If you want to stop this tool before it completes, just enter one of the following keywords into this channel: `STOP` `EXIT` `QUIT`*");

            const filter = m => (m.content.includes("STOP") || m.content.includes("EXIT") || m.content.includes("QUIT")) && m.author == message.author;
            // starts a collector to check if the user wants to stop the tool's process
            const collector = message.channel.createMessageCollector(filter, { time: 1000000 });
            collector.on('collect', () => {
                // kills the process through its PID; just killing the process through child.kill() does not work properly
                exec(`kill -9 ${child.pid}`);
                exec(`kill -9 ${child.pid + 1}`)
            });

            // when data is gathered, prints it out
            child.stdout.on('data', (data) => {
                if (data.length > 2000) {
                    let command = client.commands.get("seperateMessage");
                    command.run(message, data);
                } else {
                    message.channel.send(data);
                }
            });
            
            // when data is gathered, prints it out
            child.stderr.on('data', (data) => {
                message.channel.send(data);
            });

            // when the child process is closed, displays to the user that it was
            child.on('close', () => {
                message.channel.send(`The Gobuster command executed by <@${message.author.id}> finished/was stopped.`);
                collector.stop();
            });
            
        }
    }
}